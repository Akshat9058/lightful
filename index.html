
<!-- Created by Alvin Wan (alvinwan.com) -->
<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alvinwan/aframe-low-poly@0.0.5/dist/aframe-low-poly.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+HK:400,900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/alvinwan/mirrorvr@0.2.3/dist/mirrorvr.min.js"></script>
    <script>
$(document).ready(function() {

  function remove(selector) {
    var el = document.querySelector(selector);
    el.parentNode.removeChild(el);
  }

  function populateTemplate(orb, template, i, total) {
    var container = template.find('.container');
    var onclick = 'document.querySelector("#light-orb' + i + '").emit("switch");';

    if (orb.dependencies) {
      for (var j=0;j < orb.dependencies.length;j++) {
        onclick += 'clickOrb(' + orb.dependencies[j] + ');'
      }
    } else {
      container.find('.dep-left').remove();
      container.find('.dep-right').remove();
    }

    container.attr('id', 'container-orb' + i);
    container.attr('onclick', onclick);
    container.find('lp-sphere').attr('seed', i);

    template.attr('rotation', '0 ' + (360 / total * i) + ' 0');
    template.find('.orb').attr('id', 'orb' + i);
    template.find('.light-orb').attr('id', 'light-orb' + i);
    template.find('.clickable').attr('data-id', i);

    if (!orb.on) {
      template.find('.container').attr('scale', '0.5 0.5 0.5').attr('position', '8 0.5 0');
      template.find('.animation-scale').attr('from', '0.5 0.5 0.5').attr('to', '1 1 1');
      template.find('.animation-position').attr('from', '8 0.5 0').attr('to', '8 3 0');
      template.find('.light-orb').attr('intensity', 0);
      template.find('.animation-intensity').attr('from', 0).attr('to', 1)
    }

    return template;
  }

  for (var i=0; i < orbs.length; i++) {
    var orb = orbs[i];
    var template = $('#template').clone();
    template = populateTemplate(orb, template, i, orbs.length);
    $('#carousel').append(template);
  }

  remove('#template');
  setTimeout(transitionOrbs, 10);

  console.log(getOrbsOn());
  document.querySelector('a-scene').addEventListener('click', (e) => {
    if (e.target.nodeName != "A-ENTITY" && e.target.nodeName != "CANVAS") {
      var id = parseInt(e.target.parentNode.getAttribute('data-id'));
      toggleOrb(id);
    }
  })
});

var orbs = [
  {dependencies: [4, 1]},
  {on: true},
  {},
  {on: true},
  {}
];

function transitionOrbs() {
  document.querySelectorAll('.wrapper').forEach(function(el) {
    el.emit('transition');
  });
  document.querySelector('#content').emit('transition');
}

function win() {
  document.querySelector('#content a-text').setAttribute('value', 'Victory');
  transitionOrbs();
}

function getOrbsOn() {
  return orbs.map(orb => orb.on)
}

function toggleOrb(i) {
  orbs[i].on = !orbs[i].on;
  console.log(getOrbsOn());

  if (getOrbsOn().every(x => x)) win();
}

function clickOrb(i) {
  document.querySelector("#container-orb" + i).click();
  toggleOrb(i);
}

mirrorVR.init({

  /**
   * See the `State` section below for details.
   **/
  state: {
    position: {
      onNotify: function(data) {
        console.log('Position is ' + data.index);
      }
    }
  }
});
    </script>
    <style>
    html { background-color: #111 }
    </style>
  </head>
  <body>
    <a-scene fog="type: linear; color: #111; near:10; far:15">

      <!-- Mixins -->
      <a-assets>
        <a-mixin id="foliage" material="color:#849812"></a-mixin>
        <a-mixin id="foliage-light" material="color:#AFC91B"></a-mixin>
        <a-mixin id="text" text="
            font:kelsonsans;
            anchor:center;
            align:center;"></a-mixin>
      </a-assets>
      </a-assets>

      <!-- Lights! -->
      <a-light type="directional" castShadow="true" intensity="0.5" color="#FFF" position="2 5 0"></a-light>
      <a-light intensity="0.1" type="ambient" position="1 1 1" color="#FFF"></a-light>

      <!-- Camera! -->
      <a-entity id="rig" position="0 3 0">
        <a-camera wasd-controls look-controls>
          <a-entity cursor="fuse: true; fuseTimeout: 250"
                  position="0 0 -1"
                  geometry="primitive: ring; radiusInner: 0.03; radiusOuter: 0.04"
                  material="color: white; shader: flat; opacity: 0.5"
                  scale="0.5 0.5 0.5"
                  raycaster="far: 20; interval: 1000; objects: .clickable">
              <a-circle radius="0.01" color="#FFF" opacity="0.5" material="shader: flat"></a-circle>
            <a-animation begin="fusing" easing="ease-in" attribute="scale"
               fill="backwards" from="1 1 1" to="0.2 0.2 0.2" dur="250"></a-animation>
           </a-entity>
        </a-camera>
      </a-entity>

      <!-- Action! -->
      <a-box shadow width="75" height="0.1" depth="75" position="0 -1 0" color="#222"></a-box>

      <a-entity position="0 5 -10">
        <a-entity id="content">
          <a-text shadow value="Welcome" font="exo2bold" scale="10 10 10" align="center" baseline="center" position="0 0.5 1"></a-text>
          <lp-sphere seed="0" shadow max-amplitude="1 1 1" position="-0.5 0 -0.5"></lp-sphere>
          <lp-sphere seed="0" shadow max-amplitude="1 1 1" rotation="0 45 45" opacity="0.5" position="-0.5 0 -0.5"></lp-sphere>
          <a-ring color="#fff" material="side:double" position="0 0.5 0" radius-inner="1.9" radius-outer="2" opacity="0.25">
            <a-animation attribute="rotation" easing="linear" repeat="indefinite" from="0 0 0" to="0 360 0" dur="8000"></a-animation>
          </a-ring>
          <a-ring color="#fff" material="side:double" position="0 0.5 0" radius-inner="2.4" radius-outer="2.5" opacity="0.25">
            <a-animation attribute="rotation" easing="linear" repeat="indefinite" from="0 45 0" to="360 45 0" dur="8000"></a-animation>
          </a-ring>
          <a-ring color="#fff" material="side:double" position="0 0.5 0" radius-inner="1.4" radius-outer="1.5" opacity="0.25">
            <a-animation attribute="rotation" easing="linear" repeat="indefinite" from="0 -60 0" to="-360 -60 0" dur="3000"></a-animation>
          </a-ring>
          <a-entity position="-2 -1 0">
            <a-light class="light-orb" id="light-orb1" distance="8" type="point" color="#f90" intensity="1"></a-light>
            <a-light distance="8" type="point" color="#FFF" intensity="0.8"></a-light>
          </a-entity>
          <a-animation begin="transition" attribute="position" from="0 0 0" to="0 -10 0" dur="3000" easing="ease-elastic" direction="alternate"></a-animation>
        </a-entity>
      </a-entity>

      <a-entity id="carousel" rotation="0 0 0">
        <a-entity rotation="0 90 0" id="template" class="wrapper" position="0 -8 0">
          <a-entity id="container-orb1" class="container" position="8 3 0" scale="1 1 1" onclick="document.querySelector('#light-orb1').click()">
            <a-entity position="-2 -1 0">
              <a-light class="light-orb" id="light-orb1" distance="8" type="point" color="#f90" intensity="1">
                <a-animation class="animation-intensity" begin="switch" attribute="intensity" from="1" to="0" direction="alternate"></a-animation>
              </a-light>
              <a-light distance="8" type="point" color="#FFF" intensity="0.8"></a-light>
            </a-entity>
            <a-ring color="#fff" material="side:double" position="0 0.5 0" radius-inner="1.9" radius-outer="2" opacity="0.25">
              <a-animation attribute="rotation" easing="linear" repeat="indefinite" from="0 0 0" to="0 360 0" dur="8000"></a-animation>
            </a-ring>
            <a-ring color="#fff" material="side:double" position="0 0.5 0" radius-inner="2.4" radius-outer="2.5" opacity="0.25">
              <a-animation attribute="rotation" easing="linear" repeat="indefinite" from="0 45 0" to="360 45 0" dur="8000"></a-animation>
            </a-ring>
            <a-ring color="#fff" material="side:double" position="0 0.5 0" radius-inner="1.4" radius-outer="1.5" opacity="0.25">
              <a-animation attribute="rotation" easing="linear" repeat="indefinite" from="0 -60 0" to="-360 -60 0" dur="3000"></a-animation>
            </a-ring>
            <a-entity class="orb clickable" id="orb1">
              <lp-sphere seed="1" shadow max-amplitude="1 1 1" position="-0.5 0 -0.5"></lp-sphere>
              <lp-sphere seed="1" shadow max-amplitude="1 1 1" rotation="0 45 45" opacity="0.5" position="-0.5 0 -0.5"></lp-sphere>
              <a-animation attribute="rotation" repeat="indefinite" from="0 0 0" to="0 360 0" dur="5000"></a-animation>
            </a-entity>
            <a-animation class="animation-scale" easing="ease-elastic" begin="click" attribute="scale" from="1 1 1" to="0.5 0.5 0.5" direction="alternate" dur="2000"></a-animation>
            <a-animation class="animation-position" easing="ease-elastic" begin="click" attribute="position" from="8 3 0" to="8 0.5 0" direction="alternate" dur="2000"></a-animation>
            <a-text class="dep-right" opacity="0.25" rotation="0 -90 0" value=">" color="#FFF" scale="10 10 10" position="0 0 1" material="side:double" ></a-text>
            <a-text class="dep-left" opacity="0.25"rotation="0 -90 0" value="<" color="#FFF" scale="10 10 10" position="0 0 -3" material="side:double" ></a-text>
          </a-entity>
          <a-animation begin="transition" attribute="position" from="0 -8 0" to="0 0 0" dur="3000" easing="ease-elastic" direction="alternate"></a-animation>
        </a-entity>

      </a-entity>
    </a-scene>
  </body>
</html>
